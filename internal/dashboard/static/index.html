<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitPulse Effects</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0d1117;
        --surface: #161b22;
        --border: #30363d;
        --text: #e6edf3;
        --text-muted: #8b949e;
        --accent: #58a6ff;
        --accent-dim: #388bfd;
        --ai: #a371f7;
        --success: #3fb950;
        --danger: #f85149;
        --radius: 8px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "DM Sans", system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
      }
      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 1.5rem;
      }
      h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0 0 0.25rem 0;
        letter-spacing: -0.02em;
      }
      .subtitle {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }
      .hero-summary {
        font-size: 1.1rem;
        color: var(--text);
        margin-bottom: 1.5rem;
        line-height: 1.5;
      }
      .hero-summary .hero-highlight {
        color: var(--accent);
        font-weight: 600;
      }
      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.25rem;
      }
      .card-value {
        font-family: "JetBrains Mono", monospace;
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--accent);
      }
      .card-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 0.25rem;
      }
      .card-value.added {
        color: var(--success);
      }
      .card-value.removed {
        color: var(--danger);
      }
      .timeline {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
      }
      .timeline-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
        font-weight: 600;
        font-size: 0.9rem;
      }
      .commit-row {
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.15s;
      }
      .commit-row:hover {
        background: rgba(255, 255, 255, 0.03);
      }
      .commit-row:last-child {
        border-bottom: none;
      }
      .commit-main {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.25rem;
        flex-wrap: wrap;
      }
      .commit-hash {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.85rem;
        color: var(--accent);
      }
      .commit-msg {
        flex: 1;
        min-width: 0;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .badges {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
      }
      .badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-weight: 500;
      }
      .badge-ai {
        background: rgba(163, 113, 247, 0.2);
        color: var(--ai);
      }
      .badge-human {
        background: rgba(139, 148, 158, 0.2);
        color: var(--text-muted);
      }
      .badge-pushed {
        background: rgba(63, 185, 80, 0.2);
        color: var(--success);
      }
      .commit-date {
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .commit-expand {
        padding: 0 1.25rem 1rem 3.5rem;
        font-size: 0.85rem;
      }
      .commit-expand.files {
        display: grid;
        gap: 0.5rem;
      }
      .file-item {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 1rem;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8rem;
      }
      .file-path {
        color: var(--text);
        word-break: break-all;
      }
      .file-stats-pills {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
      }
      .file-stat-pill {
        font-size: 0.7rem;
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        min-width: 4rem;
        text-align: center;
      }
      .file-stat-add {
        background: rgba(63, 185, 80, 0.2);
        color: var(--success);
      }
      .file-stat-del {
        background: rgba(248, 81, 73, 0.2);
        color: var(--danger);
      }
      .file-stat-status {
        background: rgba(139, 148, 158, 0.2);
        color: var(--text-muted);
      }
      .empty-state {
        padding: 3rem;
        text-align: center;
        color: var(--text-muted);
      }
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        padding: 2rem;
      }
      .modal {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        max-width: 640px;
        width: 100%;
        max-height: 80vh;
        overflow: auto;
      }
      .modal-header {
        padding: 1.25rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .modal-title {
        font-weight: 600;
      }
      .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 1.5rem;
        line-height: 1;
      }
      .modal-close:hover {
        color: var(--text);
      }
      .modal-body {
        padding: 1.25rem;
      }
      .modal-body pre {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-break: break-all;
        background: var(--bg);
        padding: 1rem;
        border-radius: 6px;
        overflow-x: auto;
      }
      .diff-view {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.75rem;
        line-height: 1.5;
        background: var(--bg);
        border-radius: 6px;
        overflow: auto;
        max-height: 40vh;
      }
      .diff-line {
        display: flex;
        min-height: 1.5em;
        padding: 0 0.75rem;
      }
      .diff-line-num {
        width: 3rem;
        min-width: 3rem;
        padding-right: 1rem;
        color: var(--text-muted);
        user-select: none;
        flex-shrink: 0;
      }
      .diff-line-add {
        background: rgba(63, 185, 80, 0.15);
      }
      .diff-line-del {
        background: rgba(248, 81, 73, 0.15);
      }
      .diff-line-add .diff-line-char {
        color: var(--success);
        width: 1.2rem;
      }
      .diff-line-del .diff-line-char {
        color: var(--danger);
        width: 1.2rem;
      }
      .diff-line-hunk .diff-line-num {
        color: var(--accent);
      }
      .diff-line-content {
        white-space: pre;
        overflow-x: auto;
        flex: 1;
      }
      .modal-meta {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
      }
      .modal-file-block {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>GitPulse Effects</h1>
      <p class="subtitle">Impact from .gitpulse/history.json</p>
      <p class="hero-summary" id="hero-summary">Loading impact…</p>

      <div class="cards">
        <div class="card">
          <div class="card-value" id="stat-commits">—</div>
          <div class="card-label">Commits</div>
        </div>
        <div class="card">
          <div class="card-value" id="stat-files">—</div>
          <div class="card-label">Files Touched</div>
        </div>
        <div class="card">
          <div class="card-value added" id="stat-added">—</div>
          <div class="card-label">Lines Added</div>
        </div>
        <div class="card">
          <div class="card-value removed" id="stat-removed">—</div>
          <div class="card-label">Lines Removed</div>
        </div>
      </div>

      <div class="timeline">
        <div class="timeline-header">Activity Timeline</div>
        <div id="commit-list">
          <div class="empty-state">Loading…</div>
        </div>
      </div>
    </div>

    <div id="modal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title" id="modal-title">Commit Details</span>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
      </div>
    </div>

    <script>
      const api = "";
      let history = [];
      let expandedHash = null;
      const POLL_INTERVAL_MS = 5000;

      async function fetchStats() {
        const r = await fetch(api + "/api/stats");
        return r.json();
      }
      async function fetchHistory() {
        const r = await fetch(api + "/api/history");
        return r.json();
      }
      async function fetchCommit(hash) {
        const r = await fetch(api + "/api/commits/" + hash);
        if (!r.ok) return null;
        return r.json();
      }

      function formatDate(iso) {
        const d = new Date(iso);
        return d.toLocaleString();
      }
      function shortHash(h) {
        return h ? h.slice(0, 7) : "";
      }

      function renderStats(stats) {
        document.getElementById("stat-commits").textContent =
          stats.total_commits;
        document.getElementById("stat-files").textContent =
          stats.total_files_changed;
        document.getElementById("stat-added").textContent =
          stats.total_lines_added;
        document.getElementById("stat-removed").textContent =
          stats.total_lines_removed;
      }

      function renderHero(stats, commits) {
        const el = document.getElementById("hero-summary");
        if (!commits || commits.length === 0) {
          el.textContent =
            "No commits yet. Run GitPulse to start tracking impact.";
          return;
        }
        const today = new Date().toDateString();
        const todayCommits = commits.filter(
          (c) => new Date(c.created_at).toDateString() === today
        );
        if (todayCommits.length > 0) {
          let added = 0,
            removed = 0,
            pushed = 0;
          todayCommits.forEach((c) => {
            (c.files || []).forEach((f) => {
              added += f.lines_added || 0;
              removed += f.lines_removed || 0;
            });
            if (c.pushed) pushed++;
          });
          const net = added - removed;
          const parts = [];
          if (net > 0) parts.push(`saved ${net} lines`);
          else if (net < 0) parts.push(`cut ${Math.abs(net)} lines`);
          parts.push(
            `pushed ${pushed} of ${todayCommits.length} commits today`
          );
          el.innerHTML = `GitPulse <span class="hero-highlight">${parts.join(
            " and "
          )}</span>.`;
        } else {
          el.innerHTML = `GitPulse has made <span class="hero-highlight">${stats.total_commits} commits</span>, touching <span class="hero-highlight">${stats.total_files_changed} files</span> and <span class="hero-highlight">${stats.total_lines_added}+ / ${stats.total_lines_removed}- lines</span> in total.`;
        }
      }

      function badges(c) {
        const b = [];
        if (c.pushed) b.push('<span class="badge badge-pushed">Pushed</span>');
        return b.join("");
      }

      function formatFileStats(f) {
        const add = f.lines_added || 0;
        const del = f.lines_removed || 0;
        const status = (f.status || "modified").replace(/^./, (s) =>
          s.toUpperCase()
        );
        return `
        <span class="file-stats-pills">
          <span class="file-stat-pill file-stat-add">${add} added</span>
          <span class="file-stat-pill file-stat-del">${del} removed</span>
          <span class="file-stat-pill file-stat-status">${escapeHtml(
            status
          )}</span>
        </span>
      `;
      }

      function renderDiff(diffText) {
        if (!diffText) return "";
        const lines = diffText.split("\n");
        let html = '<div class="diff-view">';
        let num = 0;
        for (const line of lines) {
          num++;
          const first = line.charAt(0);
          const isAdd = first === "+";
          const isDel = first === "-";
          const content = isAdd || isDel ? line.slice(1) || " " : line;
          let cls = isAdd
            ? "diff-line-add"
            : isDel
            ? "diff-line-del"
            : first === "@"
            ? "diff-line-hunk"
            : "";
          const prefix = isAdd ? "+" : isDel ? "-" : " ";
          html += `<div class="diff-line ${cls}"><span class="diff-line-num">${num}</span><span class="diff-line-char">${prefix}</span><span class="diff-line-content">${escapeHtml(
            content
          )}</span></div>`;
        }
        html += "</div>";
        return html;
      }

      function renderCommitRow(c, expanded) {
        const exp = expanded ? "commit-expand" : "commit-expand hidden";
        const filesHtml = c.files
          .map(
            (f) => `
        <div class="file-item">
          <span class="file-path">${escapeHtml(f.path)}</span>
          ${formatFileStats(f)}
        </div>
      `
          )
          .join("");
        return `
        <div class="commit-row" data-hash="${escapeHtml(c.hash)}">
          <div class="commit-main">
            <span class="commit-hash">${shortHash(c.hash)}</span>
            <span class="commit-msg" title="${escapeHtml(
              c.message
            )}">${escapeHtml(c.message || "(no message)")}</span>
            <span class="badges">${badges(c)}</span>
            <span class="commit-date">${formatDate(c.created_at)}</span>
          </div>
          <div class="${exp} files">${filesHtml}</div>
        </div>
      `;
      }

      function escapeHtml(s) {
        if (!s) return "";
        const d = document.createElement("div");
        d.textContent = s;
        return d.innerHTML;
      }

      function renderList(commits, expandedHash) {
        const list = document.getElementById("commit-list");
        if (!commits.length) {
          list.innerHTML =
            '<div class="empty-state">No commits yet. Run GitPulse to start tracking.</div>';
          return;
        }
        list.innerHTML = commits
          .map((c) => renderCommitRow(c, c.hash === (expandedHash || "")))
          .join("");
        list.querySelectorAll(".commit-row").forEach((row) => {
          row.addEventListener("click", (e) => {
            if (e.target.closest(".modal-close")) return;
            const hash = row.dataset.hash;
            const alreadyExpanded = row.querySelector(
              ".commit-expand:not(.hidden)"
            );
            document
              .querySelectorAll(".commit-expand")
              .forEach((el) => el.classList.add("hidden"));
            if (!alreadyExpanded) {
              expandedHash = hash;
              row.querySelector(".commit-expand").classList.remove("hidden");
            } else {
              expandedHash = null;
            }
            // Open modal on double-click
            if (row._lastClick && Date.now() - row._lastClick < 400) {
              openModal(hash);
              row._lastClick = 0;
              return;
            }
            row._lastClick = Date.now();
          });
        });
      }

      function openModal(hash) {
        fetchCommit(hash).then((c) => {
          if (!c) return;
          document.getElementById("modal-title").textContent =
            shortHash(c.hash) + " — " + (c.message || "(no message)");
          const parts = [];
          parts.push('<div class="modal-meta">');
          parts.push("Created: " + formatDate(c.created_at));
          if (c.group_reason)
            parts.push(" · Group: " + escapeHtml(c.group_reason));
          if (c.pushed && c.pushed_at)
            parts.push(
              " · Pushed to " +
                (c.remote || "") +
                "/" +
                (c.branch || "") +
                " at " +
                formatDate(c.pushed_at)
            );
          parts.push("</div>");
          if (c.files && c.files.length) {
            c.files.forEach((f) => {
              parts.push(
                '<div class="modal-file-block"><strong>' +
                  escapeHtml(f.path) +
                  "</strong> " +
                  formatFileStats(f) +
                  "</div>"
              );
              if (f.diff) parts.push(renderDiff(f.diff));
            });
          }
          document.getElementById("modal-body").innerHTML = parts.join("");
          document.getElementById("modal").classList.remove("hidden");
        });
      }
      function closeModal() {
        document.getElementById("modal").classList.add("hidden");
      }

      async function load() {
        try {
          const [stats, commits] = await Promise.all([
            fetchStats(),
            fetchHistory(),
          ]);
          renderStats(stats);
          renderHero(stats, commits);
          history = commits;
          renderList(commits);
        } catch (err) {
          document.getElementById("commit-list").innerHTML =
            '<div class="empty-state">Failed to load. Is the dashboard server running?</div>';
        }
      }

      load();
      setInterval(load, POLL_INTERVAL_MS);
    </script>
  </body>
</html>
